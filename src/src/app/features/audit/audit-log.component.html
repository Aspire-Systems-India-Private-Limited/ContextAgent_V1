<div class="audit-container">
  <div class="card">
    <div class="header">
      <h2>
        <i class="fas fa-file-medical-alt"></i>
        Diagnosis - Audit Logs
      </h2>
    </div>
    <div class="filters-section">
      <form (ngSubmit)="onSearch()" class="filter-form">
        <div class="form-grid">
          <div class="form-group">
            <label for="startDateTime">Start DateTime</label>
            <input type="datetime-local" id="startDateTime" [(ngModel)]="startDateTime" name="startDateTime" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="endDateTime">End DateTime</label>
            <input type="datetime-local" id="endDateTime" [(ngModel)]="endDateTime" name="endDateTime" [min]="startDateTime" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="sourceFilter">Source (Optional)</label>
            <input type="text" id="sourceFilter" [(ngModel)]="sourceFilter" name="sourceFilter" placeholder="e.g., inference, agent" class="form-control">
          </div>
          <div class="form-group action-group">
            <button type="submit" class="btn btn-primary" [disabled]="loading">
              <i class="fas" [ngClass]="loading ? 'fa-spinner fa-spin' : 'fa-search'"></i>
              {{ loading ? 'Searching...' : 'Search Logs' }}
            </button>
          </div>
        </div>
      </form>
    </div>
    <div *ngIf="loading" class="loading">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Loading audit logs...</p>
    </div>
    <div *ngIf="!loading && logs.length > 0" class="log-list">
      <p class="log-count">Found {{ logs.length }} log(s)</p>
      <div *ngFor="let log of logs; let i = index" class="log-item">
        <div *ngIf="Array.isArray(log) && log.length > 0">
          <strong>Iteration {{ i + 1 }}:</strong>
          <div *ngFor="let item of log" style="margin-left: 20px;">
            <div *ngFor="let key of objectKeys(item)">
              <strong>{{ key }}:</strong> {{ formatValue(item[key]) }}
            </div>
          </div>
        </div>
        <div *ngIf="!Array.isArray(log)">
          <div *ngFor="let key of objectKeys(log)">
            <strong>{{ key }}:</strong> {{ formatValue(log[key]) }}
          </div>
        </div>
        <div class="log-actions">
          <button class="btn btn-view" (click)="openRootCauseModal(log)">
            <i class="fas fa-search"></i>
            Find Root Cause
          </button>
          <button *ngIf="log.source === 'agent'" class="btn btn-inference" (click)="openInferenceModal(log)">
            <i class="fas fa-sitemap"></i>
            Load Inference
          </button>
        </div>
      </div>
    </div>
    <div *ngIf="!loading && logs.length === 0 && searchPerformed" class="empty-state">
      <i class="fas fa-inbox"></i>
      <h3>No Audit Logs Found</h3>
      <p>Try adjusting your search criteria.</p>
    </div>
  </div>
</div>
<div *ngIf="showRootCauseModal" class="modal-overlay" (click)="closeRootCauseModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2><i class="fas fa-microscope"></i> Find Root Cause</h2>
      <button class="close-btn" (click)="closeRootCauseModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="expectedResult">Expected Result</label>
        <textarea id="expectedResult" [(ngModel)]="expectedResult" class="form-control" rows="4" placeholder="Describe the expected behavior..." required></textarea>
      </div>
      <div class="form-group">
        <label for="problemArea">Problem Area</label>
        <textarea id="problemArea" [(ngModel)]="problemArea" class="form-control" rows="4" placeholder="Describe the problem area..." required></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" (click)="submitRootCause()" [disabled]="!expectedResult || !problemArea">
          <i class="fas fa-check"></i> Submit Analysis
        </button>
        <button class="btn btn-secondary" (click)="closeRootCauseModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="showInferenceModal" class="modal-overlay" (click)="closeInferenceModal()">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2><i class="fas fa-sitemap"></i> Inference Tree</h2>
      <button class="close-btn" (click)="closeInferenceModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div *ngIf="loading" class="loading">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading inference tree...</p>
      </div>
      <div *ngIf="!loading && inferenceTreeData">
        <div class="inference-info-grid">
          <div class="info-item"><strong>Request ID:</strong> <span>{{ currentRequestId }}</span></div>
          <div class="info-item"><strong>Source:</strong> <span class="source-badge">{{ inferenceTreeData.source }}</span></div>
        </div>
        <div class="tree-summary">
          <i class="fas fa-info-circle"></i>
          <span><strong>Filter:</strong> requestId={{ currentRequestId }}, agentCode={{ currentAgentCode }}</span>
        </div>
        <div class="tree-node-item" [class.active]="selectedInferenceLog === inferenceTreeData.agent">
          <i class="fas fa-calendar"></i>
          <strong>Agent Log:</strong> {{ inferenceTreeData.agentCode }}
          <span class="tree-badge">{{ inferenceTreeData.agent.timestamp }}</span>
        </div>
        <div class="tree-section">
          <div class="tree-node-item" (click)="toggleInferenceNode('inference')">
            <i class="fas fa-chevron-right tree-toggle" [class.expanded]="isNodeExpanded('inference')"></i>
            <strong>Inference Logs</strong> ({{ inferenceTreeData.inference.length }})
          </div>
          <div class="tree-children" [class.show]="isNodeExpanded('inference')">
            <div *ngFor="let log of inferenceTreeData.inference; let idx = index" class="tree-node-item" [class.active]="selectedInferenceLog === log" (click)="selectInferenceLog(log)">
              <i class="fas fa-code"></i>
              <span>Inference {{ idx + 1 }}</span>
              <span class="tree-badge">{{ log.timestamp }}</span>
            </div>
          </div>
        </div>
        <div *ngIf="selectedInferenceLog" class="detail-panel">
          <h4>Full Content</h4>
          <div class="detail-item"><strong>Timestamp:</strong> {{ selectedInferenceLog.timestamp }}</div>
          <div class="detail-item"><strong>Request ID:</strong> {{ selectedInferenceLog.request_id }}</div>
          <div class="detail-item"><strong>Session ID:</strong> {{ selectedInferenceLog.session_id }}</div>
          <div class="detail-item">
            <strong>Content:</strong>
            <pre class="code-block">{{ formatLogContent(selectedInferenceLog.content) }}</pre>
          </div>
        </div>
      </div>
      <div *ngIf="!loading && !inferenceTreeData" class="empty-state">
        <i class="fas fa-exclamation-circle"></i>
        <h3>No Inference Data Available</h3>
        <p>Unable to load inference tree for this log.</p>
      </div>
    </div>
  </div>
</div>