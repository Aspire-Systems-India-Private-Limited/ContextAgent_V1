<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memory Management Portal</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
<link rel="icon" type="image/x-icon" href="https://www.aspiresys.com/themes/custom/asp_website/favicon.ico"/>

    <style>
      :root {
        --primary-purple: #65336e;
        --dark-purple: #542d6b;
        --bg-purple: #692e8b;
        --light-blue: #80c6ff;
        --text-light: #eee;
        --sidebar-width: 200px;
        --toolbar-height: 70px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Maven Pro", "Segoe UI", Arial, sans-serif;
        overflow: hidden;
        background: var(--text-light);
        color: #333;
      }

      .app-wrapper {
        display: flex;
        height: 100vh;
        transition: all 0.3s ease;
      }

      .sidebar {
        width: var(--sidebar-width);
        background: var(--primary-purple);
        color: var(--text-light);
        display: flex;
        flex-direction: column;
        box-shadow: 2px 0 10px rgb(101 51 110);
        position: fixed;
        height: 100vh;
        z-index: 100;
      }

      .title {
        font-size: 24px;
        font-weight: 500;
        color: var(--text-light);
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px 10px;
        cursor: pointer;
      }

      .title .ext {
        color: var(--light-blue);
        margin-left: 4px;
      }

      .sidebar button {
        background: none;
        border: none;
        color: var(--text-light);
        padding: 14px 20px;
        text-align: left;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 14px;
        transition: background-color 0.3s;
        margin-bottom: 4px;
      }

      .sidebar button.is-active,
      .sidebar button:hover {
        background-color: var(--dark-purple);
        border-radius: 8px;
      }

      .icon {
        font-size: 1.3rem;
        color: var(--text-light);
      }

      .content {
        margin-left: var(--sidebar-width);
        flex: 1;
        display: flex;
        flex-direction: column;
        transition: margin-left 0.3s ease;
      }

      .toolbar {
        height: var(--toolbar-height);
        background: var(--primary-purple);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: fixed;
        width: calc(100% - var(--sidebar-width));
        left: var(--sidebar-width);
        padding: 0px 15px;
        z-index: 99;
        border-bottom: 0.2px solid rgba(255, 255, 255, 0.1);
      }

      .page-title {
        font-size: 24px;
        font-weight: 500;
        color: var(--text-light);
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 18px 4px;
        cursor: pointer;
      }

      .user {
        color: var(--text-light);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .page-container {
        margin-top: var(--toolbar-height);
        padding: 24px;
        display: flex;
        gap: 20px;
        overflow: hidden;
        height: calc(100vh - var(--toolbar-height));
      }

      .left-panel,
      .right-panel {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 24px;
        overflow-y: auto;
      }

      .left-panel {
        flex: 2;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
        align-content: start;
        max-width:520px;
      }

      .right-panel {
        flex: 1;
        min-width: 300px;
      }

      .right-panel h3 {
        color: var(--primary-purple);
        margin-top: 0;
        margin-bottom: 16px;
      }

      .card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid #e0e0e0;
        height: fit-content;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(101, 51, 110, 0.15);
        border-color: var(--primary-purple);
      }

      .card h3 {
        margin: 0 0 8px 0;
        font-size: 15px;
        color: var(--primary-purple);
        font-weight: 600;
      }

      .card p {
        font-size: 13px;
        color: #555;
        margin: 6px 0 0 0;
        line-height: 1.5;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 16px;
      }

      label {
        font-weight: 600;
        color: #333;
        font-size: 14px;
        margin-bottom: 6px;
        display: block;
      }

      input,
      textarea {
        padding: 10px 12px;
        border-radius: 4px;
        border: 1px solid #ddd;
        font-size: 14px;
        background-color: white;
        color: #333;
        width: 100%;
        font-family: inherit;
      }

      input:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary-purple);
        box-shadow: 0 0 0 2px rgba(101, 51, 110, 0.1);
      }

      button.submit-btn {
        background-color: var(--primary-purple);
        color: var(--text-light);
        border: none;
        padding: 12px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 600;
        transition: background-color 0.3s;
      }

      button.submit-btn:hover {
        background-color: var(--dark-purple);
      }

      .metadata-field {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .metadata-field input {
        flex: 1;
      }

      .metadata-field button {
        background: none;
        border: none;
        color: #ef4444;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 6px;
        transition: opacity 0.3s;
      }

      .metadata-field button:hover {
        opacity: 0.7;
      }

      .add-meta-btn {
        background-color: #10b981;
        color: white;
        padding: 10px 16px;
        border-radius: 4px;
        font-size: 14px;
        border: none;
        cursor: pointer;
        width: fit-content;
        transition: opacity 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .add-meta-btn:hover {
        opacity: 0.85;
      }

      h4 {
        color: var(--primary-purple);
        margin: 16px 0 12px 0;
        font-size: 16px;
        font-weight: 600;
      }

      .form-section {
        grid-column: 1 / -1;
      }

      .delete-btn {
        background-color: #ef4444 !important;
      }

      .delete-btn:hover {
        background-color: #dc2626 !important;
      }

      .left-panel::-webkit-scrollbar,
      .right-panel::-webkit-scrollbar {
        width: 8px;
      }

      .left-panel::-webkit-scrollbar-track,
      .right-panel::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .left-panel::-webkit-scrollbar-thumb,
      .right-panel::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
      }

      .left-panel::-webkit-scrollbar-thumb:hover,
      .right-panel::-webkit-scrollbar-thumb:hover {
        background: #999;
      }

      pre {
        background: #f5f5f5;
        padding: 12px;
        border-radius: 4px;
        overflow-x: auto;
        margin: 8px 0;
        font-size: 13px;
        border: 1px solid #e0e0e0;
      }

      .btn-context {
        background-color: rgba(255, 255, 255, 0.1);
        color: var(--text-light);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
      }

      .btn-context:hover {
        background-color: var(--dark-purple);
        border-color: var(--light-blue);
      }

      .id-toggle-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }

      .id-toggle-btn {
        flex: 1;
        padding: 10px;
        border: 2px solid var(--primary-purple);
        background: white;
        color: var(--primary-purple);
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .id-toggle-btn.active {
        background: var(--primary-purple);
        color: white;
      }

      .id-toggle-btn:hover {
        background: var(--dark-purple);
        color: white;
      }

      .input-wrapper {
        position: relative;
      }

      .optional-badge {
        position: absolute;
        top: -8px;
        right: 8px;
        background: var(--light-blue);
        color: #333;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
      }
      .logo {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin: 11px 10px;
        cursor: pointer;
      }

      .logo-image {
        height: 45px;
        width: auto;
        object-fit: contain;
      }
      .title-text {
        font-size: 24px;
        font-weight: 500;
        color: var(--text-light);
        display: flex;
        align-items: center;
      }

      .title-text .ext {
        color: var(--text-light);
        margin-left: 4px;
      }
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        grid-column: 1 / -1;
        height: 150px;
        font-size: 16px;
        color: #666;
      }
      .loading::after {
        content: "⏳ Loading...";
        animation: blink 1s linear infinite;
      }
      @keyframes blink {
        0%,
        50%,
        100% {
          opacity: 1;
        }
        25%,
        75% {
          opacity: 0.3;
        }
      }
    </style>
  </head>

  <body>
    <div class="app-wrapper">
      <div class="sidebar">
        <div class="logo">
          <img
            src="/static/aspire.svg"
            alt="Company Logo"
            class="logo-image"
            onerror="this.style.display='none'"
          />
        </div>
        <button class="is-active" onclick="switchSection('addMemory')">
          <i class="fas fa-plus icon"></i> Create Memory
        </button>
        <button onclick="switchSection('searchMemory')">
          <i class="fas fa-search icon"></i> Search Memory
        </button>
      </div>

      <div class="content">
        <div class="toolbar">
          <div class="page-title">Memory</div>
          <div class="user">{% include "navbar.html"%}</div>
        </div>

        <div class="page-container">
          <div class="left-panel" id="left-panel"></div>
          <div class="right-panel" id="right-panel">
            <h3>Details</h3>
            <p>Select a card from the left to see details here.</p>
          </div>
        </div>
      </div>
    </div>
    <script src="/static/config.js"></script>
    <script>
      const API = {
        addMemory: async (data) =>
          fetch(`${API_BASE}/memory/add`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          }).then((res) => res.json()),

        searchMemory: async (query) =>
          fetch(`${API_BASE}/memory/search`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(query),
          }).then((res) => res.json()),

        listMemory: async (user_id) =>
          fetch(`${API_BASE}/memory-user/list?user_id=${user_id}`).then((res) =>
            res.json()
          ),

        deleteMemory: async (memory_id, user_id) =>
          fetch(`${API_BASE}/memory/delete/${memory_id}?user_id=${user_id}`, {
            method: "DELETE",
          }).then((res) => res.json()),
      };

      const leftPanel = document.getElementById("left-panel");
      const rightPanel = document.getElementById("right-panel");

      let currentIdType = "user"; // 'user' or 'agent'

      function goToContext() {
        window.location.href = "/context";
      }
      function goToAudit() {
        window.location.href = "/audit";
      }
      function goToSession() {
        window.location.href = "/session";
      }
      function goToHome() {
        window.location.href = "/admin";
      }
      function goToMetrics() {
        window.location.href = "/cost";
      }
      function goToAgentSolution() {
        window.location.href = "/agent-sol";
      }

      function switchSection(section) {
        document
          .querySelectorAll(".sidebar button")
          .forEach((btn) => btn.classList.remove("is-active"));
        const buttons = document.querySelectorAll(".sidebar button");
        if (section === "addMemory") buttons[0].classList.add("is-active");
        if (section === "searchMemory") buttons[1].classList.add("is-active");
        if (section === "listMemory") buttons[2].classList.add("is-active");

        if (section === "addMemory") renderAddMemory();
        if (section === "searchMemory") renderSearchMemory();
        if (section === "listMemory") renderListMemory();
      }

      function toggleIdType(type, inputId) {
        currentIdType = type;
        const buttons = document.querySelectorAll(".id-toggle-btn");
        buttons.forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");

        const input = document.getElementById(inputId);
        if (type === "user") {
          input.placeholder = "Enter User ID";
        } else {
          input.placeholder = "Enter Agent ID";
        }
      }

      function renderAddMemory() {
        currentIdType = "user";
        leftPanel.style.display = "block";
        leftPanel.style.gridTemplateColumns = "1fr";
        leftPanel.innerHTML = `
        <form onsubmit="addMemoryForm(event)" class="form-section">
          <div>
            <label>Select ID Type</label>
            <div class="id-toggle-group">
              <button type="button" class="id-toggle-btn active" onclick="toggleIdType('user', 'userId')">
                <i class="fas fa-user"></i> User ID
              </button>
              <button type="button" class="id-toggle-btn" onclick="toggleIdType('agent', 'userId')">
                <i class="fas fa-robot"></i> Agent ID
              </button>
            </div>
          </div>

          <div class="input-wrapper">
            <label id="userIdLabel">User ID / Agent ID</label>
            <span class="optional-badge">Optional: Either one required</span>
            <input type="text" id="userId" placeholder="Enter User ID" required>
          </div>
    
          <div>
            <label>Content</label>
            <textarea id="memoryContent" rows="4" required></textarea>
          </div>
    
          <h4>Metadata</h4>
          <div id="metadataContainer">
            <div class="metadata-field">
              <input type="text" class="meta-key" value="memory_type" required>
              <input type="text" class="meta-value" placeholder="Type" required>
            </div>
          </div>
          <button type="button" class="add-meta-btn" onclick="addMetadataField()">
            <i class="fas fa-plus"></i> Add Metadata
          </button>
    
          <button type="submit" class="submit-btn"><i class="fas fa-plus"></i> Add Memory</button>
        </form>
      `;

        rightPanel.innerHTML =
          "<h3>Add Memory</h3><p>Fill the form to add a new memory. You can provide either User ID or Agent ID (both work the same way).</p>";
      }

      function addMetadataField() {
        const container = document.getElementById("metadataContainer");
        const div = document.createElement("div");
        div.className = "metadata-field";
        div.innerHTML = `
        <input type="text" placeholder="Key" class="meta-key" required>
        <input type="text" placeholder="Value" class="meta-value" required>
        <button type="button" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
      `;
        container.appendChild(div);
      }

      async function addMemoryForm(e) {
        e.preventDefault();
        const user_id = document.getElementById("userId").value;

        if (!user_id) {
          alert("⚠️ Please provide either User ID or Agent ID");
          return;
        }

        const content = document.getElementById("memoryContent").value;

        const metadata = {};
        document.querySelectorAll(".metadata-field").forEach((f) => {
          const key = f.querySelector(".meta-key").value;
          const value = f.querySelector(".meta-value").value;
          if (key) metadata[key] = value;
        });

        const data = { user_id, content, metadata };
        leftPanel.innerHTML = '<div class="loading"></div>';

        try {
          const res = await API.addMemory(data);
          alert("✅ Memory added successfully!");
          console.log("Add Memory Response:", res);
          e.target.reset();
          renderAddMemory();
        } catch (err) {
          alert("❌ Failed to add memory: " + err.message);
          renderAddMemory();
        }
      }

      function renderSearchMemory() {
        currentIdType = "user";
        leftPanel.style.display = "block";
        leftPanel.style.gridTemplateColumns = "1fr";
        leftPanel.innerHTML = `
        <form onsubmit="searchMemoryForm(event)" class="form-section">
          <div>
            <label>Select ID Type</label>
            <div class="id-toggle-group">
              <button type="button" class="id-toggle-btn active" onclick="toggleIdType('user', 'searchUserId')">
                <i class="fas fa-user"></i> User ID
              </button>
              <button type="button" class="id-toggle-btn" onclick="toggleIdType('agent', 'searchUserId')">
                <i class="fas fa-robot"></i> Agent ID
              </button>
            </div>
          </div>

          <div class="input-wrapper">
            <label>User ID / Agent ID</label>
            <span class="optional-badge">Optional: Either one required</span>
            <input type="text" id="searchUserId" placeholder="Enter User ID" required>
          </div>
    
          <div>
            <label>Query</label>
            <input type="text" id="searchQuery" required>
          </div>
    
          <button type="submit" class="submit-btn"><i class="fas fa-search"></i> Search</button>
        </form>
      `;

        rightPanel.innerHTML =
          "<h3>Search Memory</h3><p>Results will appear as cards on the left. You can use either User ID or Agent ID.</p>";
      }

      async function searchMemoryForm(e) {
        e.preventDefault();
        const userId = document.getElementById("searchUserId").value;

        if (!userId) {
          alert("⚠️ Please provide either User ID or Agent ID");
          return;
        }

        const queryData = {
          query: document.getElementById("searchQuery").value,
          user_id: userId,
        };
        leftPanel.innerHTML = '<div class="loading"></div>';
        try {
          const response = await API.searchMemory(queryData);
          console.log("Search API response:", response);

          let results = [];
          if (Array.isArray(response)) results = response;
          else if (Array.isArray(response.results)) results = response.results;
          else if (response.result && Array.isArray(response.result))
            results = response.result;

          renderMemoryCards(results, false, true);
        } catch (err) {
          leftPanel.innerHTML =
            '<p style="grid-column:1/-1; text-align:center; padding:40px; color:#666;">Failed to load results.</p>';
          alert("❌ Failed to search memory: " + err.message);
        }
      }

      function renderListMemory() {
        currentIdType = "user";
        leftPanel.style.display = "block";
        leftPanel.style.gridTemplateColumns = "1fr";
        leftPanel.innerHTML = `
        <form onsubmit="listMemoryForm(event)" class="form-section">
          <div>
            <label>Select ID Type</label>
            <div class="id-toggle-group">
              <button type="button" class="id-toggle-btn active" onclick="toggleIdType('user', 'listUserId')">
                <i class="fas fa-user"></i> User ID
              </button>
              <button type="button" class="id-toggle-btn" onclick="toggleIdType('agent', 'listUserId')">
                <i class="fas fa-robot"></i> Agent ID
              </button>
            </div>
          </div>

          <div class="input-wrapper">
            <label>User ID / Agent ID</label>
            <span class="optional-badge">Optional: Either one required</span>
            <input type="text" id="listUserId" placeholder="Enter User ID" required>
          </div>

          <button type="submit" class="submit-btn"><i class="fas fa-list"></i> List All</button>
        </form>
      `;
        rightPanel.innerHTML =
          "<h3>List Memories</h3><p>Results will appear as cards on the left. You can use either User ID or Agent ID.</p>";
      }

      async function listMemoryForm(e) {
        e.preventDefault();
        const user_id = document.getElementById("listUserId").value;

        if (!user_id) {
          alert("⚠️ Please provide either User ID or Agent ID");
          return;
        }

        const results = await API.listMemory(user_id);
        renderMemoryCards(results, false, false);
      }

      function renderMemoryCards(items, showScore = false, isSearch = false) {
        leftPanel.style.gridTemplateColumns =
          "repeat(auto-fill, minmax(220px, 1fr))";
        leftPanel.innerHTML = "";
        rightPanel.innerHTML =
          "<h3>Details</h3><p>Select a card from the left.</p>";

        if (!Array.isArray(items) || items.length === 0) {
          leftPanel.innerHTML =
            '<p style="grid-column: 1/-1; text-align:center; padding:40px; color:#666;">No results found.</p>';
          return;
        }

        items.forEach((item) => {
          const text = item.memory || item.content || "(No content)";
          const id = item.id || item.memory_id || "N/A";
          const userId = item.user_id || "Unknown";

          const card = document.createElement("div");
          card.className = "card";

          if (isSearch) {
            card.innerHTML = `
            <h3>User/Agent: ${userId}</h3>
            <p><strong>Content:</strong> ${text.substring(0, 80)}${
              text.length > 80 ? "..." : ""
            }</p>
          `;
          } else {
            card.innerHTML = `
            <h3>ID: ${id.substring(0, 8)}...</h3>
            <p><strong>Content:</strong> ${text.substring(0, 80)}${
              text.length > 80 ? "..." : ""
            }</p>
          `;
          }

          card.onclick = () => {
            rightPanel.innerHTML = `
            <h3>${isSearch ? "User/Agent ID" : "Memory ID"}</h3>
            <p style="margin-bottom:16px; color:#666; font-size:13px;">${
              isSearch ? userId : id
            }</p>
            <h4 style="margin-bottom:8px;">Content</h4>
            <p style="background: #f5f5f5; padding: 12px; border-radius: 4px; margin-bottom:16px; border:1px solid #e0e0e0; line-height:1.6;">${text}</p>
            <h4 style="margin-bottom:8px;">Metadata</h4>
            <pre>${JSON.stringify(item.metadata || {}, null, 2)}</pre>
            <button class="submit-btn delete-btn" onclick="deleteMemory('${id}','${userId}')" style="margin-top:16px;">
              <i class="fas fa-trash"></i> Delete Memory
            </button>
          `;
          };
          leftPanel.appendChild(card);
        });
      }

      async function deleteMemory(memory_id, user_id) {
        if (confirm("Are you sure you want to delete this memory?")) {
          await API.deleteMemory(memory_id, user_id);
          alert("✅ Memory deleted successfully!");
          switchSection("listMemory");
        }
      }

      switchSection("addMemory");
    </script>
  </body>
</html>
