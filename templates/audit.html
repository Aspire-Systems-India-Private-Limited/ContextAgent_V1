<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diagnosis</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" type="image/x-icon" href="https://www.aspiresys.com/themes/custom/asp_website/favicon.ico"/>
<style>
  :root {
    --primary-purple: #65336e;
    --dark-purple: #542d6b;
    --light-blue: #80c6ff;
    --text-light: #eee;
    --card: #65336e;
  }

  body {
    background-color: #eee;
    color: #333;
    font-family: 'Maven Pro', 'Segoe UI', Arial, sans-serif;
    margin: 0;
    padding: 0;
  }

  .toolbar {
    height: 70px;
    background: var(--primary-purple);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 24px;
    position: fixed;
    width: calc(100% - 48px);
    top: 0;
    z-index: 1000;
    box-shadow: 0 2px 10px rgb(101 51 110);
    border-bottom: 0.2px solid rgb(101 51 110);
  }

  .logo {
    font-size: 26px;
    font-weight: 500;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-image {
    height: 45px;
    width: auto;
    object-fit: contain;
  }

  .user { 
    display: flex; 
    gap: 10px; 
  }
  
 
.nav-buttons {
    display: flex;
    gap: 10px;
  }

  .btn-icon {
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--text-light);
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
  }

  .btn-icon:hover {
    background-color: var(--dark-purple);
    border-color: var(--light-blue);
    transform: translateY(-2px);
  }
/* === Sidebar === */
  .sidebar {
    position: fixed;
    top: 69px;
    left: 0;
    width: 200px;
    height: calc(100% - 70px);
    background: var(--card);
    display: flex;
    flex-direction: column;
    padding: 20px 10px;
    box-shadow: 2px 0 8px rgba(0,0,0,0.1);
    z-index: 999;
  }

  .sidebar-btn {
    background: transparent;
    color: var(--text-light);
    border: none;
    padding: 10px 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    font-size: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    transition: all 0.3s;
  }

  .sidebar-btn:hover, .sidebar-btn.active {
    background: var(--dark-purple);
    transform: translateY(-2px);
  }

  .sidebar-btn-content {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .submenu {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    padding-left: 0px;
    margin-bottom: 10px;
  }

  .submenu.open {
    max-height: 200px;
  }

  .submenu-btn {
    background: transparent;
    color: var(--text-light);
    border: none;
    padding: 8px 44px;
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
  }

  .submenu-btn:hover, .submenu-btn.active {
    background: var(--dark-purple);
    transform: translateX(5px);
  }

  .chevron {
    transition: transform 0.3s;
  }

  .chevron.rotate {
    transform: rotate(90deg);
  }

  .page-container { 
    margin-left: 220px;
    margin-top: 90px;
    max-width: 900px; 
    padding: 24px; 
  }
  
  .card { 
    background-color: white; 
    border-radius: 8px; 
    padding: 24px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
  }
  
  .form-group { 
    margin-bottom: 20px; 
  }
  
  label { 
    font-weight: 600; 
    display: block; 
    margin-bottom: 8px; 
    font-size: 14px; 
    color: #333; 
  }
  
  input, select, textarea { 
    width: 100%; 
    background-color: white; 
    border: 1px solid #ddd; 
    color: #333; 
    padding: 10px 6px; 
    border-radius: 4px; 
    font-size: 14px; 
    font-family: inherit; 
    box-sizing: border-box;
  }
  
  .btn { 
    background-color: #65336e; 
    color: #eee; 
    padding: 10px 24px; 
    border-radius: 4px; 
    cursor: pointer; 
    transition: 0.3s; 
    border: none; 
    font-weight: 500; 
    font-size: 14px; 
  }
  
  .btn:hover { 
    background-color: #542d6b; 
  }

  h2 { 
    color: #333; 
    margin-bottom: 20px; 
    font-size: 22px; 
    font-weight: 500; 
  }
  
  h3 { 
    color: #333; 
    margin-bottom: 16px; 
    font-size: 18px; 
    font-weight: 500; 
  }

  .log-item {
    background-color: #f8f9fa; 
    padding: 16px; 
    border-radius: 8px;
    margin-bottom: 12px; 
    font-size: 13px; 
    border: 1px solid #e0e0e0;
  }

  .log-item p {
    margin: 4px 0;
  }

  pre {
    background-color: #f5f5f5; 
    padding: 12px; 
    border-radius: 4px;
    overflow-x: auto; 
    white-space: pre-wrap; 
    margin-top: 8px; 
    font-size: 13px;
    word-wrap: break-word;
  }

  /* Modal */
  .modal {
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(0,0,0,0.5); 
    z-index: 9999; 
    justify-content: center; 
    align-items: center;
    overflow-y: auto;
  }
  
  .modal-content {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    width: 700px;
    max-width: 95%;
    max-height: 90vh; 
    overflow-y: auto;
    position: relative;
  }
  
  .modal-content textarea {
    font-family: inherit;
    font-size: 13px;
    resize: vertical;
    box-sizing: border-box;
  }
  
  .modal-content span.close {
    position: absolute;
    top: 10px;
    right: 12px;
    cursor: pointer;
    font-weight: bold;
    font-size: 18px;
    color: #333;
  }
  
  .modal-content span.close:hover {
    color: #65336e;
  }

  .loading {
    text-align: center;
    padding: 20px;
    color: #666;
  }

  .error {
    color: #d32f2f;
    padding: 12px;
    background-color: #ffebee;
    border-radius: 4px;
    margin-top: 12px;
  }

  .source-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    margin-left: 8px;
    background-color: #e3f2fd;
    color: #1976d2;
  }
  .title-text {
    font-size: 24px;
    font-weight: 500;
    color: var(--text-light);
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 20px 10px;
    cursor: pointer;
  }
  
  .title-text .ext {
    color: var(--text-light);
    margin-left: 4px;
  }
</style>
</head>
<body>

<div class="toolbar">
  <div class="logo">
    <img src="/static/aspire.svg" alt="Company Logo" class="logo-image" onerror="this.style.display='none'">
    <span class="title-text">Diagnosis</span>
  </div>
  <div class="user">
     <div class="user">{% include "navbar.html" %}</div>
  </div>
</div>

<!-- Sidebar -->
<div class="sidebar">
  <button id="metrics-btn" class="sidebar-btn">
    <div class="sidebar-btn-content">
      <i class="fa-solid fa-chart-bar"></i>
      <span>Metrics</span>
    </div>
    <i class="fa-solid fa-chevron-right chevron"></i>
  </button>
  <div id="metrics-submenu" class="submenu">
    <button id="cost-btn" class="submenu-btn"><i class="fa-solid fa-dollar-sign"></i> Cost</button>
    <button id="performance-btn" class="submenu-btn"><i class="fa-solid fa-gauge-high"></i> Performance</button>
  </div>
  <button id="diagnosis-btn" class="sidebar-btn active">
    <div class="sidebar-btn-content">
      <i class="fas fa-file-alt"></i>
      <span>Diagnostics</span>
    </div>
  </button>
  <button id="ag-btn" class="sidebar-btn">
    <div class="sidebar-btn-content">
      <i class="fa-solid fa-chart-bar"></i>
      <span>Aggregate Cost</span>
    </div>
    <i class="fa-solid fa-chevron-right chevron"></i>
  </button>
</div>

<div class="page-container">
  <div class="card">
    <h2>Inferences</h2>
    <form id="auditLogsForm">  
      <div class="form-group">
        <label>Start Date & Time (UTC)</label>
        <input type="datetime-local" id="startDateTime" required />
      </div>

      <div class="form-group">
        <label>End Date & Time (UTC)</label>
        <input type="datetime-local" id="endDateTime" required />
      </div>

      <div class="form-group">
        <label>Source</label>
        <select id="sourceFilter" required>
          <option value="">-- Select Source --</option>
          <option value="agent">agent</option>
          <option value="inference">inference</option>
          <option value="contextdiscovery">contextdiscovery</option>
        </select>
      </div>
      
      <button type="submit" class="btn">Fetch</button>
    </form>

    <div id="auditLogsResults" style="margin-top:24px;"></div>
  </div>
</div>

<!-- Root Cause Modal -->
<div id="rootCauseModal" class="modal">
  <div class="modal-content">
    <span id="rootCauseClose" class="close">&times;</span>
    <h3>Find Root Cause Analysis</h3>
    <form id="rootCauseForm">
      <div style="margin-bottom:12px;">
        <label>Expected Result</label>
        <textarea id="expectedResult" style="width: 100%; height: 150px;" placeholder="Describe what should have happened..."></textarea>
      </div>
      <div style="margin-bottom:12px;">
        <label>Problem Area In Context</label>
        <textarea id="problemArea" style="width: 100%; height: 150px;" placeholder="Describe the issue or unexpected behavior..."></textarea>
      </div>
      <button type="submit" class="btn">Analyze Root Cause</button>
    </form>
  </div>
</div>

<script src="/static/config.js"></script>
<script>
// Navigation functions
function goToMemory(){ window.location.href="/memory"; }
function goToContext(){ window.location.href="/context"; }
function goToSession(){ window.location.href="/session"; }
function goToHome(){ window.location.href="/admin"; }
function goToMetrics(){ window.location.href="/cost"; }
function goToAgentSolution(){ window.location.href="/agent-sol"; }

// Sidebar functionality
const metricsBtn = document.getElementById('metrics-btn');
const metricsSubmenu = document.getElementById('metrics-submenu');
const chevron = metricsBtn.querySelector('.chevron');

// Open submenu by default
metricsSubmenu.classList.add('open');
chevron.classList.add('rotate');

metricsBtn.addEventListener('click', () => {
  metricsSubmenu.classList.toggle('open');
  chevron.classList.toggle('rotate');
});

document.getElementById("cost-btn").addEventListener("click", () => {
  window.location.href = '/cost';
});

document.getElementById("performance-btn").addEventListener("click", () => {
  window.location.href = '/cost';
});

document.getElementById("diagnosis-btn").addEventListener("click", () => {
  window.location.href = '/audit';
});

document.getElementById("ag-btn").addEventListener("click", () => {
  window.location.href = '/aggregated';
});

// Set default datetime values (last 1 hour)
function initializeDateTimes() {
  const now = new Date();
  const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
  
  // Format for datetime-local input (YYYY-MM-DDTHH:mm)
  const formatDateTime = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  };
  
  document.getElementById("startDateTime").value = formatDateTime(oneHourAgo);
  document.getElementById("endDateTime").value = formatDateTime(now);
}

initializeDateTimes();

// Main form submission
document.getElementById("auditLogsForm").addEventListener("submit", async e => {
  e.preventDefault();
  
  const startDateTime = document.getElementById("startDateTime").value;
  const endDateTime = document.getElementById("endDateTime").value;
  const source = document.getElementById("sourceFilter").value.trim();
  const resultsDiv = document.getElementById("auditLogsResults");
  
  if (!startDateTime || !endDateTime) {
    resultsDiv.innerHTML = '<div class="error">‚ö†Ô∏è Please select both start and end date/time</div>';
    return;
  }

  // Convert to ISO format for API
  const startISO = new Date(startDateTime).toISOString();
  const endISO = new Date(endDateTime).toISOString();
  
  // Validate date range
  if (new Date(startDateTime) >= new Date(endDateTime)) {
    resultsDiv.innerHTML = '<div class="error">‚ö†Ô∏è Start date/time must be before end date/time</div>';
    return;
  }

  // Build URL with parameters
  let url = `${API_BASE}/logs-by-datetime-source?start_time=${encodeURIComponent(startISO)}&end_time=${encodeURIComponent(endISO)}`;
  
  if (source) {
    url += `&source=${encodeURIComponent(source)}`;
  }

  resultsDiv.innerHTML = '<div class="loading">‚è≥ Loading Inferences...</div>';

  try {
    const res = await fetch(url);
    
    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(`Server returned ${res.status}: ${errorText}`);
    }
    
    const data = await res.json();
    
    if (!Array.isArray(data) || data.length === 0) {
      resultsDiv.innerHTML = '<p style="color: #666;">‚ÑπÔ∏è No Inferences found for the specified criteria.</p>';
      return;
    }

    displayAuditLogs(data, resultsDiv);

  } catch(err) {
    console.error('Fetch error:', err);
    resultsDiv.innerHTML = `<div class="error">‚ùå Failed to fetch Inferences: ${err.message}</div>`;
  }
});

// Display audit logs with descending date sort
function displayAuditLogs(data, container) {
  if (!Array.isArray(data)) {
    console.error("Expected array data but got:", data);
    container.innerHTML = "<p style='color:red;'>Invalid data format</p>";
    return;
  }

  // Sort by createdOn in descending order (newest first)
  data.sort((a, b) => {
    const dateA = new Date(a.createdOn || 0);
    const dateB = new Date(b.createdOn || 0);
    return dateB - dateA;
  });

  container.innerHTML = `<h3>Found ${data.length} Inferences Log${data.length !== 1 ? 's' : ''}</h3>`;

  data.forEach(log => {
    const div = document.createElement("div");
    div.className = "log-item";

    const sourceBadge = log.source ? `<span class="source-badge">${escapeHtml(log.source)}</span>` : '';

    div.innerHTML = `
      <p><strong>ID:</strong> ${escapeHtml(log.id)}</p>
      <p><strong>Source:</strong> ${escapeHtml(log.source || 'N/A')}</p>
      <p><strong>Session ID:</strong> ${escapeHtml(log.sessionId || 'N/A')}</p>
      <p><strong>User ID:</strong> ${escapeHtml(log.userId || 'N/A')}</p>
      <p><strong>Request ID:</strong> ${escapeHtml(log.requestId || 'N/A')}</p>
      <p><strong>Created On:</strong> ${escapeHtml(log.createdOn)}</p>
      <p><strong>Modified On:</strong> ${escapeHtml(log.modifiedOn || 'N/A')}</p>
      <h4>Content:</h4>
    `;

    // Handle the "content" array with nested objects
    if (Array.isArray(log.content)) {
      log.content.forEach(item => {
        const contentBlock = document.createElement("div");
        contentBlock.className = "content-block";
        contentBlock.innerHTML = `<h5>Iteration ${escapeHtml(item.iteration)}</h5>`;

        const pre = document.createElement("pre");

        // üü¢ Unescape and beautify request/response content
        if (item.request || item.response) {
          let text = "";
          if (item.request) text += `üü¶ Request:\n${item.request.trim()}\n\n`;
          if (item.response) text += `üü© Response:\n${item.response.trim()}`;
          pre.innerText = text; // preserves newlines
        } else {
          pre.textContent = JSON.stringify(item, null, 2);
        }

        contentBlock.appendChild(pre);

        // üü¢ Add missing fields (refinement, model, etc.)
        const metaInfo = document.createElement("div");
        metaInfo.className = "meta-info";
        metaInfo.innerHTML = `
          <p><strong>Refinement:</strong> ${escapeHtml(item.refinement || 'N/A')}</p>
          <p><strong>Model:</strong> ${escapeHtml(item.model || 'N/A')}</p>
          <p><strong>Cost:</strong> ${escapeHtml(item.cost || 'N/A')}</p>
          <p><strong>Agent Code:</strong> ${escapeHtml(item.agent_code || 'N/A')}</p>
          <p><strong>User ID:</strong> ${escapeHtml(item.user_id || 'N/A')}</p>
          <p><strong>Context Code:</strong> ${escapeHtml(item.context_code || 'N/A')}</p>
          <p><strong>Token Count:</strong> ${escapeHtml(item.token_count || 'N/A')}</p>
          <p><strong>AI Call Time:</strong> ${escapeHtml(item.ai_call_time || 'N/A')}</p>
          <p><strong>Iteration Time:</strong> ${escapeHtml(item.iteration_time || 'N/A')}</p>
          <p><strong>Version:</strong> ${escapeHtml(item.version || 'N/A')}</p>
          <p><strong>User Name:</strong> ${escapeHtml(item.user_name || 'N/A')}</p>
        `;
        contentBlock.appendChild(metaInfo);

        div.appendChild(contentBlock);
      });
    } else {
      // fallback if content is not an array
      const pre = document.createElement("pre");
      pre.textContent = JSON.stringify(log.content, null, 2);
      div.appendChild(pre);
    }

    // Add "Find Root Cause" button
    const btn = document.createElement("button");
    btn.textContent = "Find Root Cause";
    btn.className = "btn";
    btn.style.marginTop = "8px";
    btn.onclick = () => openRootCauseModal(log);
    div.appendChild(btn);

    container.appendChild(div);
  });
}

// Utility to prevent XSS when displaying HTML
function escapeHtml(text) {
  if (text === null || text === undefined) return '';
  return text.toString()
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}


// Root Cause Modal
const rootCauseModal = document.getElementById("rootCauseModal");
const rootCauseClose = document.getElementById("rootCauseClose");
const rootCauseForm = document.getElementById("rootCauseForm");

function openRootCauseModal(log) {
  rootCauseModal.dataset.logId = log.id;
  rootCauseModal.dataset.logContent = JSON.stringify(log);
  document.getElementById("expectedResult").value = "";
  document.getElementById("problemArea").value = "";
  rootCauseModal.style.display = "flex";
}

rootCauseClose.onclick = () => {
  rootCauseModal.style.display = "none";
};

window.onclick = e => {
  if (e.target === rootCauseModal) {
    rootCauseModal.style.display = "none";
  }
};

rootCauseForm.onsubmit = async e => {
  e.preventDefault();
  
  const logId = rootCauseModal.dataset.logId;
  const logContent = rootCauseModal.dataset.logContent;
  const expected = document.getElementById("expectedResult").value.trim();
  const problem = document.getElementById("problemArea").value.trim();
  
  if (!expected || !problem) {
    alert("‚ö†Ô∏è Please fill in both fields.");
    return;
  }

  // Log the root cause analysis
  console.log("Root Cause Analysis Submitted:", {
    logId,
    logContent: JSON.parse(logContent),
    expectedResult: expected,
    problemArea: problem,
    timestamp: new Date().toISOString()
  });

  alert("‚úÖ Root Cause analysis submitted successfully!");
  rootCauseModal.style.display = "none";
};
</script>
</body>
</html>