<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agent Metrics</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" type="image/x-icon" href="https://www.aspiresys.com/themes/custom/asp_website/favicon.ico"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  :root {
    --primary-purple: #65336e;
    --dark-purple: #542d6b;
    --bg-purple: #692e8b;
    --light-blue: #80c6ff;
    --text-light: #eee;
    --bg: #f8f8fb;
    --card: #65336e;
    --text: #DBEDF3;
    --sub: #404B69;
    --warn: #ff6b6b;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: #333;
    font-family: "Maven Pro", Arial, sans-serif;
    overflow-x: hidden;
  }

  /* === Toolbar === */
  .toolbar {
    height: 70px;
    background: var(--primary-purple);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 24px;
    position: fixed;
    width: 100%;
    top: 0;
    z-index: 1000;
    box-shadow: 0 2px 10px rgb(101 51 110);
    border-bottom: 0.2px solid rgb(101 51 110);
  }

  .logo {
    font-size: 26px;
    font-weight: 500;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-image {
    height: 50px;
    width: auto;
    object-fit: contain;
  }

  .nav-buttons {
    display: flex;
    gap: 10px;
  }

  .nav-btn {
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--text-light);
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
  }

  .nav-btn:hover, .nav-btn.active {
    background-color: var(--dark-purple);
    border-color: var(--light-blue);
    transform: translateY(-2px);
  }

/* === Sidebar === */
  .sidebar {
    position: fixed;
    top: 69px;
    left: 0;
    width: 200px;
    height: calc(100% - 70px);
    background: var(--card);
    display: flex;
    flex-direction: column;
    padding: 20px 10px;
    box-shadow: 2px 0 8px rgba(0,0,0,0.1);
    z-index: 999;
  }

  .sidebar-btn {
    background: transparent;
    color: var(--text-light);
    border: none;
    padding: 10px 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    font-size: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    transition: all 0.3s;
  }

  .sidebar-btn:hover, .sidebar-btn.active {
    background: var(--dark-purple);
    transform: translateY(-2px);
  }

  .sidebar-btn-content {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .submenu {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    padding-left: 0px;
    margin-bottom: 10px;
  }

  .submenu.open {
    max-height: 200px;
  }

  .submenu-btn {
    background: transparent;
    color: var(--text-light);
    border: none;
    padding: 8px 44px;
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
  }

  .submenu-btn:hover, .submenu-btn.active {
    background: var(--dark-purple);
    transform: translateX(5px);
  }

  .chevron {
    transition: transform 0.3s;
  }

  .chevron.rotate {
    transform: rotate(90deg);
  }

  /* === Main Content === */
  .content-wrapper {
    margin-left: 220px;
    margin-top: 90px;
    padding: 20px;
  }

  h1 {
    font-size: 28px;
    color: var(--primary-purple);
    margin-bottom: 20px;
  }

  /* === Form Layout === */
  #metrics-form {
    background: #f5f5f5;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: flex-end;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  #metrics-form div {
    display: flex;
    flex-direction: column;
    flex: 1 1 180px;
    min-width: 160px;
  }

  #metrics-form label {
    font-weight: 500;
    color: #333;
    margin-bottom: 4px;
  }

  #metrics-form input {
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
    width: 100%;
  }

  #metrics-form button {
    padding: 12px 24px;
    border-radius: 6px;
    background: var(--primary-purple);
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: 0.3s;
  }

  #metrics-form button:hover {
    background: var(--dark-purple);
  }

  /* === Summary Section === */
  #summary {
    margin-bottom: 16px;
    font-size: 14px;
    color: #0a0a0a;
    font-weight: bold;
  }

  /* === FIXED HEADER TABLE WITH SCROLL === */
  .table-container {
  max-height: 600px; /* Shows approximately 10 rows before scrolling */
  overflow-y: auto;
  overflow-x: auto;
  border: 1px solid #e0e0e0;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(101, 51, 110, 0.25);
  position: relative;
}

  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: #fff;
  }

  thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--primary-purple);
  }

  th {
    text-align: left;
    padding: 12px 16px;
    background: var(--primary-purple);
    color: #fff;
    font-weight: 600;
    font-size: 14px;
    white-space: nowrap;
    border-bottom: 2px solid var(--dark-purple);
  }

  td {
    text-align: left;
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
    font-size: 14px;
    max-width: 300px;
    word-wrap: break-word;
  }

  tbody tr {
    background-color: white;
    transition: background-color 0.2s;
  }

  tbody tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  tbody tr:hover {
    background: #f9f9ff;
  }

  .loading {
    text-align: center;
    color: var(--primary-purple);
    padding: 16px;
  }

  .no-data {
    text-align: center;
    color: #999;
    padding: 20px;
  }
  #chart-container {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(101, 51, 110, 0.15);
  display: none;
}

#metrics-chart {
  max-height: 400px;
}

  .audit-link {
    color: #65336e;
    text-decoration: underline;
    cursor: pointer;
  }

  .audit-link:hover {
    color: #542d6b;
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    overflow-y: auto;
  }

  .modal-content {
    background: #fff;
    margin: 50px auto;
    padding: 30px;
    border-radius: 8px;
    max-width: 800px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .modal-header h2 {
    color: var(--primary-purple);
    margin: 0;
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
  }

  .close-btn:hover {
    color: #333;
  }

  .modal-body {
    max-height: 500px;
    overflow-y: auto;
    background: #f9f9ff;
    padding: 20px;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
  }
  .title-text {
    font-size: 24px;
    font-weight: 500;
    color: var(--text-light);
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 20px 10px;
    cursor: pointer;
  }
  
  .title-text .ext {
    color: var(--text-light);
    margin-left: 4px;
  }
</style>
</head>

<body>
  <!-- === TOP NAV BAR === -->
  <div class="toolbar">
    <div class="logo">
      <img src="/static/aspire.svg" alt="Company Logo" class="logo-image" onerror="this.style.display='none'">
      <span class="title-text">Agent Metrics</span>
    </div>

    <div class="nav-buttons">
     {%include "navbar.html" %}
    </div>
  </div>

  <div class="sidebar">
    <button id="metrics-btn" class="sidebar-btn">
      <div class="sidebar-btn-content">
        <i class="fa-solid fa-chart-bar"></i>
        <span>Metrics</span>
      </div>
      <i class="fa-solid fa-chevron-right chevron"></i>
    </button>
    <div id="metrics-submenu" class="submenu">
      <button id="cost-btn" class="submenu-btn active"><i class="fa-solid fa-dollar-sign"></i> Cost</button>
      <button id="performance-btn" class="submenu-btn"><i class="fa-solid fa-gauge-high"></i> Performance</button>
    </div>
    <button id="diagnosis-btn" class="sidebar-btn">
      <div class="sidebar-btn-content">
        <i class="fas fa-file-alt"></i>
        <span>Diagnostics</span>
      </div>
    </button>
    <button id="aggregated-btn" class="sidebar-btn">
      <div class="sidebar-btn-content">
        <i class="fas fa-coins"></i>
        <span>Aggregated Cost</span>
      </div>
    </button>

  </div>

  
  <div class="content-wrapper">
    <h1 id="page-title">Agent Metrics [Cost]</h1>

    <form id="metrics-form">
      <div>
        <label>Agent Code:</label>
        <input type="text" id="agent_code" placeholder="e.g., agent code" required/>
      </div>
      <div>
        <label>Start Time:</label>
        <input type="datetime-local" id="start_time" required />
      </div>
      <div>
        <label>End Time:</label>
        <input type="datetime-local" id="end_time" required />
      </div>
      <div>
        <label>Min Value:</label>
        <input type="number" id="min_value" step="0.01" placeholder="Optional" />
      </div>
      <div>
        <label>Max Value:</label>
        <input type="number" id="max_value" step="0.01" placeholder="Optional" />
      </div>
      <div>
        <button type="submit"><i class="fa-solid fa-search"></i> Fetch</button>
      </div>
    </form>

    <div id="summary" style="display: none;"></div>

   <div id="chart-container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <h3 style="color: #65336e; margin: 0;">Metrics Chart</h3>
    <div style="display: flex; align-items: center; gap: 10px;">
      <label style="font-weight: 500; color: #333; margin: 0;">Filter by Intent:</label>
      <select id="intent-filter" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; min-width: 200px;">
        <option value="all">All Intents</option>
      </select>
    </div>
  </div>
  <canvas id="metrics-chart"></canvas>
</div>

<div id="loading" class="loading" style="display:none;">Loading...</div>
    <div id="no-data" class="no-data" style="display:none;">No metrics found.</div>

    <div class="table-container" id="table-container" style="display:none;">
      <table id="results-table">
        <thead>
          <tr id="table-header"></tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal for Session/Request Logs -->
  <div id="auditModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Session Logs</h2>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <div class="modal-body" id="auditContent"></div>
    </div>
  </div>

<script src="/static/config.js"></script>
  <script>
  const form = document.getElementById('metrics-form');
  const tableContainer = document.getElementById('table-container');
  const table = document.getElementById('results-table');
  const tbody = document.getElementById('table-body');
  const loading = document.getElementById('loading');
  const noData = document.getElementById('no-data');
  const summaryDiv = document.getElementById('summary');
  const tableHeader = document.getElementById('table-header');

  let selectedMetricCode = "COST";
  let metricsChart = null;
  let allRecords = [];

  // Submenu toggle
  const metricsBtn = document.getElementById('metrics-btn');
  const metricsSubmenu = document.getElementById('metrics-submenu');
  const chevron = metricsBtn.querySelector('.chevron');

  // Open submenu by default
  metricsSubmenu.classList.add('open');
  chevron.classList.add('rotate');

  metricsBtn.addEventListener('click', () => {
    metricsSubmenu.classList.toggle('open');
    chevron.classList.toggle('rotate');
  });

  document.getElementById("cost-btn").addEventListener("click", () => {
    selectedMetricCode = "COST";
    highlightSubmenu("cost");
    resetDisplay();
    document.getElementById("page-title").textContent = "Agent Metrics [Cost]";
  });

  document.getElementById("performance-btn").addEventListener("click", () => {
    selectedMetricCode = "PERFORMANCE";
    highlightSubmenu("performance");
    resetDisplay();
    document.getElementById("page-title").textContent = "Agent Metrics [Performance]";
  });

  function resetDisplay() {
    tableContainer.style.display = 'none';
    tbody.innerHTML = '';
    summaryDiv.style.display = 'none';
    summaryDiv.innerHTML = '';
    document.getElementById('chart-container').style.display = 'none';
  if (metricsChart) {
    metricsChart.destroy();
    metricsChart = null;
  }
  }

  function highlightSubmenu(type) {
    document.querySelectorAll(".submenu-btn").forEach(btn => btn.classList.remove("active"));
    const btn = document.getElementById(`${type}-btn`);
    if (btn) {
      btn.classList.add("active");
    }
  }

  document.getElementById("diagnosis-btn").addEventListener("click", () => {
    window.location.href = '/audit';
  });

  document.getElementById("aggregated-btn").addEventListener("click", () => {
  window.location.href = '/aggregated';
  });


  // === DYNAMIC TABLE RENDERING - Shows specific fields only ===
function renderDynamicTable(records) {
  if (!records || records.length === 0) {
    noData.style.display = 'block';
    return;
  }

  // Sort records by DateTime in descending order (newest first)
  records.sort((a, b) => {
    const dateA = new Date(a.DateTime || 0);
    const dateB = new Date(b.DateTime || 0);
    return dateB - dateA; // Descending order
  });

  const columnOrder = [
    'DateTime',
    'IntentCode',
    'UserName',
    'RequestId',
    'SessionId',
    'TokenCount',
    'MetricValue',
    'Model'
  ];

  // Create table header with special handling for MetricValue
  tableHeader.innerHTML = columnOrder.map(key => {
    let headerText = key;
    if (key === 'MetricValue' && selectedMetricCode === 'PERFORMANCE') {
      headerText = 'MetricValue (sec)';
    }
    return `<th>${escapeHtml(headerText)}</th>`;
  }).join('');

  // Create table rows with only the specified columns
  tbody.innerHTML = records.map(record => {
    const cells = columnOrder.map(key => {
      let value = record[key];
      if (key === 'IntentCode' && (!value || value.trim() === '')) {
        value = 'agent';
      }
      // Handle special cases for clickable links
      if (key === 'SessionId' && value) {
        return `<td><a class="audit-link" onclick="openSessionLogs('${value}')">${escapeHtml(value)}</a></td>`;
      }
      if (key === 'RequestId' && value) {
        return `<td><a class="audit-link" onclick="openRequestLogs('${value}')">${escapeHtml(value)}</a></td>`;
      }
     
      // Format value based on type
      if (value === null || value === undefined) {
        value = '-';
      } else if (typeof value === 'object') {
        value = JSON.stringify(value);
      } else if (typeof value === 'boolean') {
        value = value ? '‚úÖ' : '‚ùå';
      } else if (typeof value === 'number') {
        value = value.toFixed(4);
      }
     
      return `<td>${escapeHtml(String(value))}</td>`;
    }).join('');
   
    return `<tr>${cells}</tr>`;
  }).join('');

  tableContainer.style.display = 'block';
}

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // === Fetch Metrics ===
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const agentCode = document.getElementById('agent_code').value.trim();
    const startTime = document.getElementById('start_time').value;
    const endTime = document.getElementById('end_time').value;
    const minValue = document.getElementById('min_value').value.trim();
    const maxValue = document.getElementById('max_value').value.trim();

    if (!startTime || !endTime) {
      alert('Please provide start and end times.');
      return;
    }

    loading.style.display = 'block';
    noData.style.display = 'none';
    tableContainer.style.display = 'none';
    summaryDiv.style.display = 'none';
    summaryDiv.innerHTML = '';
    tbody.innerHTML = '';

    try {
      const url = new URL(`${API_BASE}/agent-metrics`);
      if (agentCode) url.searchParams.append('agent_code', agentCode);
      url.searchParams.append('metric_code', selectedMetricCode);
      url.searchParams.append('start_time', new Date(startTime).toISOString());
      url.searchParams.append('end_time', new Date(endTime).toISOString());
      if (minValue) url.searchParams.append('min_value', minValue);
      if (maxValue) url.searchParams.append('max_value', maxValue);

      const res = await fetch(url);
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();

      loading.style.display = 'none';

     if (!data || !data.length) {
      noData.style.display = 'block';
      document.getElementById('chart-container').style.display = 'none';  
      if (metricsChart) {                                                  
        metricsChart.destroy();                                            
        metricsChart = null;                                               
      }                                                                    
      return;
    }

      // Extract records correctly
      let records = Array.isArray(data[0]?.Metrics) ? data[0].Metrics : data;

      // Filter by metric code if needed
      if (selectedMetricCode === "COST") {
        records = records.filter(r => (r.MetricCode || '').toLowerCase() === 'cost');
      } else if (selectedMetricCode === "PERFORMANCE") {
        records = records.filter(r => (r.MetricCode || '').toLowerCase() === 'performance');
      }

      if (!records.length) {
      noData.style.display = 'block';
      document.getElementById('chart-container').style.display = 'none';  
      if (metricsChart) {                                                  
        metricsChart.destroy();                                            
        metricsChart = null;                                               
      }                                                                    
      return;
    }

      // Show summary
      if (selectedMetricCode === "COST" && data[0].TotalCost !== undefined) {
        summaryDiv.style.display = 'block';
        summaryDiv.textContent = `Total Cost: $${data[0].TotalCost.toFixed(4)} | Total Records: ${records.length}`;
      } else if (selectedMetricCode === "PERFORMANCE" && data[0].average_performance !== undefined) {
        summaryDiv.style.display = 'block';
        summaryDiv.textContent = `Average Performance: ${data[0].average_performance.toFixed(4)} | Total Records: ${records.length}`;
      }

      allRecords = records;
      populateIntentFilter(records);
      renderChart(records, 'all');

      // Render dynamic table with ALL fields
      renderDynamicTable(records);

    } catch (err) {
      loading.style.display = 'none';
      alert('Error fetching metrics: ' + err.message);
    }
  });

  // === Modal Functions ===
  const auditModal = document.getElementById('auditModal');
  const closeModal = document.getElementById('closeModal');
  const auditContent = document.getElementById('auditContent');
  const modalTitle = document.getElementById('modal-title');

  closeModal.addEventListener('click', () => {
    auditModal.style.display = 'none';
  });

  auditModal.addEventListener('click', (e) => {
    if (e.target === auditModal) {
      auditModal.style.display = 'none';
    }
  });

  async function openSessionLogs(sessionId) {
    if (!sessionId) return;
    modalTitle.textContent = 'Session Logs';
    auditModal.style.display = 'block';
    auditContent.innerHTML = '<p style="text-align:center; color:#666;">Loading session logs...</p>';

    try {
      const res = await fetch(`${API_BASE}/sessions/${sessionId}`);
      if (!res.ok) throw new Error('Failed to fetch session logs');
      const data = await res.json();

      // üü¢ Safely stringify the main data
    let beautified = JSON.stringify(data, null, 2);

    // üü¢ Extract and decode "content" fields
    beautified = beautified.replace(
      /"content":\s*"([\s\S]*?)"(,?)/g,
      (match, content, comma) => {
        try {
          // Remove escaped characters and newlines
          let unescaped = content
            .replace(/\\"/g, '"')
            .replace(/\\r\\n/g, '\n')
            .replace(/\\n/g, '\n')
            .replace(/\\t/g, '  ')
            .replace(/^"""\s*|\s*"""$/g, ''); // remove triple quotes if any

          return `"content": \n${unescaped.trim()}\n${comma}`;
        } catch {
          return match;
        }
      }
    );

    // üü¢ Include missing metadata fields at the end if they exist
    const metaKeys = [
      "refinement", "model", "cost", "agent_code", "user_id",
      "context_code", "token_count", "ai_call_time",
      "iteration_time", "version", "user_name"
    ];

    let metaBlock = '';
    metaKeys.forEach(key => {
      if (data[key] !== undefined) {
        metaBlock += `\n${key}: ${data[key] ?? 'null'}`;
      }
    });

    // üü¢ Combine everything into formatted HTML
    const formattedHtml = `
      <pre style="
        background:#fff;
        padding:15px;
        border-radius:4px;
        font-family:monospace;
        font-size:13px;
        line-height:1.6;
        color:#333;
        white-space:pre-wrap;
        word-wrap:break-word;
      ">
${beautified}${metaBlock ? '\n\n' + metaBlock : ''}
      </pre>
    `;

    auditContent.innerHTML = formattedHtml;
} catch (err) {
      auditContent.innerHTML = `<p style="color:#d32f2f;">Error loading session logs: ${err.message}</p>`;
    }
  }

 async function openRequestLogs(requestId) {
  if (!requestId) return;

  modalTitle.textContent = 'Request Logs';
  auditModal.style.display = 'block';
  auditContent.innerHTML = '<p style="text-align:center; color:#666;">Loading request logs...</p>';

  try {
    const res = await fetch(`${API_BASE}/req/${requestId}`);
    if (!res.ok) throw new Error('Failed to fetch request logs');
    const data = await res.json();

    // üü¢ Safely stringify the main data
    let beautified = JSON.stringify(data, null, 2);

    // üü¢ Extract and decode "content" fields
    beautified = beautified.replace(
      /"content":\s*"([\s\S]*?)"(,?)/g,
      (match, content, comma) => {
        try {
          // Remove escaped characters and newlines
          let unescaped = content
            .replace(/\\"/g, '"')
            .replace(/\\r\\n/g, '\n')
            .replace(/\\n/g, '\n')
            .replace(/\\t/g, '  ')
            .replace(/^"""\s*|\s*"""$/g, ''); // remove triple quotes if any

          return `"content": \n${unescaped.trim()}\n${comma}`;
        } catch {
          return match;
        }
      }
    );

    // üü¢ Include missing metadata fields at the end if they exist
    const metaKeys = [
      "refinement", "model", "cost", "agent_code", "user_id",
      "context_code", "token_count", "ai_call_time",
      "iteration_time", "version", "user_name"
    ];

    let metaBlock = '';
    metaKeys.forEach(key => {
      if (data[key] !== undefined) {
        metaBlock += `\n${key}: ${data[key] ?? 'null'}`;
      }
    });

    // üü¢ Combine everything into formatted HTML
    const formattedHtml = `
      <pre style="
        background:#fff;
        padding:15px;
        border-radius:4px;
        font-family:monospace;
        font-size:13px;
        line-height:1.6;
        color:#333;
        white-space:pre-wrap;
        word-wrap:break-word;
      ">
${beautified}${metaBlock ? '\n\n' + metaBlock : ''}
      </pre>
    `;

    auditContent.innerHTML = formattedHtml;
  } catch (err) {
    auditContent.innerHTML = `<p style="color:#d32f2f;">Error loading request logs: ${err.message}</p>`;
  }
}

function renderChart(records, selectedIntent = 'all') {
  const chartContainer = document.getElementById('chart-container');
  const canvas = document.getElementById('metrics-chart');
  
  if (!records || records.length === 0) {
    chartContainer.style.display = 'none';
    return;
  }

  
  const normalizedRecords = records.map(r => ({
    ...r,
    IntentCode: (!r.IntentCode || r.IntentCode === '-' || r.IntentCode.trim() === '') ? 'agent' : r.IntentCode
  }));

  // Filter records based on selected intent
  const filteredRecords = selectedIntent === 'all' 
    ? normalizedRecords 
    : normalizedRecords.filter(r => r.IntentCode === selectedIntent);

  if (filteredRecords.length === 0) {
    chartContainer.style.display = 'none';
    return;
  }

  // Sort by DateTime ascending for proper chart display
  const sortedRecords = [...filteredRecords].sort((a, b) => {
    return new Date(a.DateTime) - new Date(b.DateTime);
  });

  // Extract data for chart
  const labels = sortedRecords.map(r => {
    const date = new Date(r.DateTime);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  });
  
  const values = sortedRecords.map(r => parseFloat(r.MetricValue) || 0);

  // Destroy existing chart if any
  if (metricsChart) {
    metricsChart.destroy();
  }

  // Create new chart
  chartContainer.style.display = 'block';
  
  const ctx = canvas.getContext('2d');
  metricsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: selectedMetricCode === 'COST' ? 'Cost ($)' : 'Performance (sec)',
        data: values,
        borderColor: '#65336e',
        backgroundColor: 'rgba(101, 51, 110, 0.1)',
        borderWidth: 2,
        tension: 0.4,
        fill: true,
        pointRadius: 2,
        pointHoverRadius: 4,
        pointBackgroundColor: '#65336e',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: true,
          position: 'top',
        },
        title: {
          display: true,
          text: `${selectedMetricCode === 'COST' ? 'Cost' : 'Performance'} ${selectedIntent !== 'all' ? ' - ' + selectedIntent : ''}`,
          font: { size: 16, weight: 'bold' },
          color: '#65336e'
        },
        tooltip: {
          mode: 'index',
          intersect: false,
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: selectedMetricCode === 'COST' ? 'Cost ($)' : 'Time (seconds)',
            color: '#666'
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Date & Time',
            color: '#666'
          },
          ticks: {
            maxRotation: 45,
            minRotation: 45
          },
          grid: {
            display: false
          }
        }
      }
    }
  });
}

function populateIntentFilter(records) {
  const filterSelect = document.getElementById('intent-filter');

  const normalizedRecords = records.map(r => ({
    ...r,
    IntentCode: (!r.IntentCode || r.IntentCode === '-' || r.IntentCode.trim() === '') ? 'agent' : r.IntentCode
  }));
  
  
  const uniqueIntents = [...new Set(normalizedRecords.map(r => r.IntentCode))].sort();
  
  
  filterSelect.innerHTML = '<option value="all">All Intents</option>';
  
  
  uniqueIntents.forEach(intent => {
    const option = document.createElement('option');
    option.value = intent;
    option.textContent = intent;
    filterSelect.appendChild(option);
  });
  
  filterSelect.value = 'all';
  
 
  filterSelect.onchange = function() {
    renderChart(allRecords, this.value);
  };
}

  // Make functions globally available
  window.openSessionLogs = openSessionLogs;
  window.openRequestLogs = openRequestLogs;
  </script>
</body>
</html>