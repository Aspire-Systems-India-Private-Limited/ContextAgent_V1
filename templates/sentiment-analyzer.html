<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Feedback Sentiment Analyzer</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" type="image/x-icon" href="https://www.aspiresys.com/themes/custom/asp_website/favicon.ico"/>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  :root {
    --primary-purple: #65336e;
    --dark-purple: #542d6b;
    --light-blue: #80c6ff;
    --text-light: #eee;
    --card: #65336e;
    --success: #10b981;
    --warn: #ff6b6b;
    --sidebar-width: 250px;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    background: #f5f7fa;
    color: #333;
    font-family: "Maven Pro", Arial, sans-serif;
    overflow-x: hidden;
  }

  .toolbar {
    height: 70px;
    background: var(--primary-purple);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 24px;
    position: fixed;
    width: 100%;
    top: 0;
    z-index: 1000;
    box-shadow: 0 2px 10px rgb(101 51 110);
  }

   .logo {
    font-size: 26px;
    font-weight: 500;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-image {
    height: 45px;
    width: auto;
    object-fit: contain;
  }

  .logo .ext {
    color: var(--light-blue);
  }
    .nav-buttons {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: nowrap;
  }

  .nav-buttons .user {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: nowrap;
  }

  .menu-toggle {
    display: none;
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 24px;
    cursor: pointer;
  }

  .sidebar {
    position: fixed;
    left: 0;
    top: 70px;
    width: var(--sidebar-width);
    height: calc(100vh - 70px);
    background: linear-gradient(180deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
    box-shadow: 2px 0 10px rgba(0,0,0,0.2);
    transition: transform 0.3s ease;
    z-index: 999;
    overflow-y: auto;
  }

  .sidebar-nav {
    padding: 20px 0;
  }

  .sidebar-item {
    padding: 16px 24px;
    color: var(--text-light);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s;
    cursor: pointer;
    border-left: 4px solid transparent;
  }

  .sidebar-item:hover {
    background: rgba(255,255,255,0.1);
    border-left-color: var(--light-blue);
  }

  .sidebar-item.active {
    background: rgba(128, 198, 255, 0.2);
    border-left-color: var(--light-blue);
    font-weight: 600;
  }

  .content-wrapper {
    margin-top: 70px;
    margin-left: var(--sidebar-width);
    padding: 30px;
    transition: margin-left 0.3s ease;
  }

  h1 {
    margin-bottom: 24px;
    font-size: 32px;
    color: var(--primary-purple);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .filter-section {
    background: white;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .filter-options {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .filter-option {
    flex: 1;
    min-width: 150px;
    padding: 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8f9fa;
  }

  .filter-option:hover {
    border-color: var(--light-blue);
    background: #e6f7ff;
  }

  .filter-option.selected {
    border-color: var(--primary-purple);
    background: linear-gradient(135deg, var(--card) 0%, #7a4a82 100%);
    color: white;
    font-weight: 600;
  }

  .filter-option i {
    font-size: 24px;
    margin-bottom: 8px;
    display: block;
  }

  .filter-row {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .filter-input-wrapper {
    flex: 1;
    min-width: 200px;
    position: relative;
  }

  .filter-input-wrapper label {
    display: block;
    color: var(--primary-purple);
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 14px;
  }

  .filter-input-wrapper input {
    width: 100%;
    padding: 12px 16px;
    border-radius: 6px;
    border: 2px solid #ddd;
    font-size: 14px;
    transition: all 0.3s;
  }

  .filter-input-wrapper input:focus {
    outline: none;
    border-color: var(--light-blue);
    box-shadow: 0 0 0 3px rgba(128, 198, 255, 0.1);
  }

  .filter-actions {
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }

  .btn {
    padding: 12px 32px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
    white-space: nowrap;
  }

  .btn-primary {
    background: var(--primary-purple);
    color: white;
  }

  .btn-primary:hover {
    background: var(--dark-purple);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(101, 51, 110, 0.3);
  }

  .btn-secondary {
    background: #6c757d;
    color: white;
  }

  .btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-2px);
  }

  .stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
    display: none;
  }

  .stats-cards.show {
    display: grid;
  }

  .stat-card {
    background: linear-gradient(135deg, var(--card) 0%, #7a4a82 100%);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(101, 51, 110, 0.25);
    text-align: center;
    transition: all 0.3s;
  }

  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 20px rgba(101, 51, 110, 0.35);
  }

  .stat-card-icon {
    font-size: 32px;
    margin-bottom: 8px;
  }

  .stat-card-value {
    font-size: 32px;
    font-weight: 700;
    color: white;
    margin-bottom: 4px;
  }

  .stat-card-label {
    font-size: 13px;
    color: rgba(255,255,255,0.9);
    letter-spacing: 0.5px;
  }

  .table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1900px;
  }

  thead {
    background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
  }

  thead th {
    padding: 16px 12px;
    text-align: left;
    color: white;
    font-weight: 600;
    font-size: 13px;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  tbody tr {
    border-bottom: 1px solid #e9ecef;
    transition: background 0.2s;
  }

  tbody tr:hover {
    background: #f8f9fa;
  }

  tbody td {
    padding: 14px 12px;
    color: #495057;
    font-size: 13px;
    vertical-align: top;
  }

  .rating-stars {
    color: #ffc107;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .rating-number {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-left: 6px;
  }

  .sentiment-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .sentiment-badge.Positive {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
  }

  .sentiment-badge.Negative {
    background: rgba(255, 107, 107, 0.1);
    color: var(--warn);
  }

  .sentiment-badge.Neutral {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
  }

  .score-badge {
    display: inline-block;
    background: #667eea;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }

  .text-cell {
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .text-cell.expanded {
    white-space: normal;
    max-width: none;
  }

  .expand-btn {
    background: none;
    border: none;
    color: var(--primary-purple);
    cursor: pointer;
    font-size: 12px;
    padding: 4px 8px;
    margin-top: 4px;
    text-decoration: underline;
  }

  .expand-btn:hover {
    color: var(--dark-purple);
  }

  .list-items {
    margin: 0;
    padding-left: 16px;
    font-size: 12px;
    line-height: 1.6;
  }

  .list-items li {
    margin-bottom: 4px;
  }

  .category-detail {
    background: #f8f9fa;
    padding: 8px;
    margin: 4px 0;
    border-radius: 4px;
    border-left: 3px solid #667eea;
    font-size: 12px;
  }

  .category-detail-header {
    font-weight: 600;
    color: #667eea;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .category-accordion {
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin: 4px 0;
    overflow: hidden;
  }

  .category-accordion-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 10px 12px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    font-size: 13px;
    transition: all 0.3s;
    user-select: none;
  }

  .category-accordion-header:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b46a0 100%);
  }

  .category-accordion-header i {
    transition: transform 0.3s;
  }

  .category-accordion-header.active i {
    transform: rotate(180deg);
  }

  .category-accordion-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    background: white;
  }

  .category-accordion-body.active {
    max-height: 1000px;
    transition: max-height 0.5s ease-in;
  }

  .category-accordion-content {
    padding: 12px;
  }

  .category-sentence {
    color: #333;
    margin: 4px 0;
    font-style: italic;
  }

  .category-meta {
    display: flex;
    gap: 12px;
    margin-top: 4px;
    font-size: 11px;
  }

  .category-sentiment-tag {
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
  }

  .category-sentiment-tag.Positive {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
  }

  .category-sentiment-tag.Negative {
    background: rgba(255, 107, 107, 0.1);
    color: var(--warn);
  }

  .category-sentiment-tag.Neutral {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
  }

  .empty-state {
    text-align: center;
    padding: 80px 20px;
    color: #6c757d;
  }

  .empty-state i {
    font-size: 64px;
    margin-bottom: 16px;
    display: block;
    opacity: 0.5;
  }

  .loading {
    padding: 60px 20px;
    color: var(--primary-purple);
  }

  .loading i {
    margin-left:150px;
    font-size: 48px;
    margin-bottom: 16px;
    display: block;
  }
 /* Autocomplete Dropdown Styles */
  .autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid var(--light-blue);
    border-top: none;
    border-radius: 0 0 6px 6px;
    max-height: 200px;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
  }

  .autocomplete-dropdown.show {
    display: block;
  }

  .autocomplete-item {
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.2s;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .autocomplete-item:last-child {
    border-bottom: none;
  }

  .autocomplete-item:hover {
    background: #f8f9fa;
  }

  .autocomplete-item.selected {
    background: rgba(128, 198, 255, 0.1);
  }

  .autocomplete-item i {
    color: var(--primary-purple);
    font-size: 14px;
  }

  .autocomplete-loading {
    padding: 12px 16px;
    text-align: center;
    color: #999;
    font-size: 13px;
  }

  .autocomplete-no-results {
    padding: 12px 16px;
    text-align: center;
    color: #999;
    font-size: 13px;
  }

  @keyframes spin {
    100% { transform: rotate(360deg); }
  }

  .error-message {
    background: rgba(255, 107, 107, 0.1);
    color: var(--warn);
    padding: 16px;
    border-radius: 8px;
    border-left: 4px solid var(--warn);
    margin-bottom: 20px;
  }

  @media (max-width: 768px) {
    .menu-toggle {
      display: block;
    }

    .sidebar {
      transform: translateX(-100%);
    }

    .sidebar.active {
      transform: translateX(0);
    }

    .content-wrapper {
      margin-left: 0;
    }

    .filter-options {
      flex-direction: column;
    }

    .filter-option {
      min-width: 100%;
    }
  }
</style>
</head>
<body>

<div class="toolbar">
  <button class="menu-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </button>
    <div class="logo">
    <img src="/static/aspire.svg" alt="Company Logo" class="logo-image" onerror="this.style.display='none'">
    <span>Sentiment Analyzer</span>
  </div>
  <div class="nav-buttons">
     <div class="user">{% include "navbar.html" %}</div>
  </div>
</div>

<div class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <a href="/session" class="sidebar-item">
      <i class="fas fa-comments"></i>
      <span>User Interaction</span>
    </a>
    <a href="/sentiment" class="sidebar-item active">
      <i class="fas fa-chart-line"></i>
      <span>Sentiment Analyzer</span>
    </a>
  </nav>
</div>

<div class="content-wrapper">
  <h1>
    <i data-lucide="bar-chart-3"></i>
    Sentiment Analysis
  </h1>

  <div class="filter-section">
    <div class="filter-row">
      <div class="filter-input-wrapper">
        <label>
          <i class="fas fa-robot"></i> Agent CODE
        </label>
        <input 
          type="text" 
          id="filterInput" 
          placeholder="Start typing agent code..."
          autocomplete="off"
        >
        <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
      </div>

      <div class="filter-input-wrapper">
        <label>
          <i class="fas fa-calendar"></i> Start Date
        </label>
        <input type="datetime-local" id="startDate">
      </div>

      <div class="filter-input-wrapper">
        <label>
          <i class="fas fa-calendar"></i> End Date
        </label>
        <input type="datetime-local" id="endDate">
      </div>
    </div>

    <div class="filter-actions">
      <button class="btn btn-primary" onclick="loadFeedback()">
        <i class="fas fa-search"></i>
        Search
      </button>
      <button class="btn btn-secondary" onclick="resetFilters()">
        <i class="fas fa-redo"></i>
        Reset
      </button>
    </div>
  </div>

  <div id="errorContainer"></div>

  <div class="stats-cards" id="statsCards">
    <div class="stat-card">
      <div class="stat-card-icon">üìä</div>
      <div class="stat-card-value" id="totalFeedback">0</div>
      <div class="stat-card-label">Total Feedback</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-icon">üòä</div>
      <div class="stat-card-value" id="positiveFeedback">0</div>
      <div class="stat-card-label">Positive</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-icon">üòê</div>
      <div class="stat-card-value" id="neutralFeedback">0</div>
      <div class="stat-card-label">Neutral</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-icon">üòû</div>
      <div class="stat-card-value" id="negativeFeedback">0</div>
      <div class="stat-card-label">Negative</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-icon">üéØ</div>
      <div class="stat-card-value" id="overallSentiment">N/A</div>
      <div class="stat-card-label">Overall Sentiment</div>
    </div>
  </div>

  <div class="table-container">
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
            <th>User Name</th>
            <th>Session ID</th>
            <th>Created At</th>
            <th>Rating</th>
            <th>Sentiment</th>
            <th>Scores</th>
            <th>Summary</th>
            <th>Original Feedback</th>
            <th>Positive Points</th>
            <th>Negative Points</th>
            <th>Categories</th>
            <th>Request</th>
            <th>Response</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="feedbackTable">
          <tr>
            <td colspan="16" class="loading">
              <i class="fas fa-info-circle"></i>
              <div>Enter Agent ID and date range, then click "Search" to view feedback data</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="/static/config.js"></script>
<script>
let AGENT_LIST = [];
let AGENT_MAP = {};
let selectedIndex = -1;
let agentsLoading = false;

// Fetch agents from API
async function fetchAgents() {
  try {
    agentsLoading = true;
    const response = await fetch(`${API_BASE}/agents/`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`Failed to fetch agents: ${response.status}`);
    }
    
    const data = await response.json();
    
    AGENT_LIST = [];
    AGENT_MAP = {};
    data.forEach(agent => {
    const code = agent.code || agent.name;
    const id = agent.id || agent.agent_id;
    if (code && id) {
        AGENT_LIST.push(code);
        AGENT_MAP[code] = id;
    }
    });

    console.log('Agent code to ID map:', AGENT_MAP);
    agentsLoading = false;
    return AGENT_LIST;
  } catch (error) {
    console.error('Error fetching agents:', error);
    agentsLoading = false;
    // Fallback to empty list or show error
    AGENT_LIST = [];
    return AGENT_LIST;
  }
}

// Initialize autocomplete
async function initAutocomplete() {
  const input = document.getElementById('filterInput');
  const dropdown = document.getElementById('autocompleteDropdown');
  
  // Load agents on initialization
  await fetchAgents();
  
  // Show all options on focus
  input.addEventListener('focus', async () => {
    if (AGENT_LIST.length === 0 && !agentsLoading) {
      await fetchAgents();
    }
    
    if (!input.value.trim()) {
      renderAutocomplete(AGENT_LIST);
    }
  });
  
  // Filter as user types
  input.addEventListener('input', (e) => {
    const value = e.target.value.trim().toLowerCase();
    
    if (value.length === 0) {
      // Show all options when empty
      renderAutocomplete(AGENT_LIST);
      return;
    }
    
    // Filter agents based on input
    const filtered = AGENT_LIST.filter(agent => 
      agent.toLowerCase().includes(value)
    );
    
    renderAutocomplete(filtered);
  });
  
  // Keyboard navigation
  input.addEventListener('keydown', (e) => {
    const items = dropdown.querySelectorAll('.autocomplete-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
      updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, -1);
      updateSelection(items);
    } else if (e.key === 'Enter' && selectedIndex >= 0) {
      e.preventDefault();
      items[selectedIndex].click();
    } else if (e.key === 'Escape') {
      hideAutocomplete();
    }
  });
  
  // Click outside to close
  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
      hideAutocomplete();
    }
  });
}

// Render autocomplete dropdown
function renderAutocomplete(suggestions) {
  const dropdown = document.getElementById('autocompleteDropdown');
  selectedIndex = -1;
  
  if (agentsLoading) {
    dropdown.innerHTML = '<div class="autocomplete-loading"><i class="fas fa-spinner fa-spin"></i> Loading agents...</div>';
    dropdown.classList.add('show');
    return;
  }
  
  if (suggestions.length === 0) {
    dropdown.innerHTML = '<div class="autocomplete-no-results"><i class="fas fa-search"></i> No matching agents</div>';
    dropdown.classList.add('show');
    return;
  }
  
  dropdown.innerHTML = suggestions
    .map((agent, index) => `
      <div class="autocomplete-item" data-value="${agent}" data-index="${index}">
        <span>${agent}</span>
      </div>
    `)
    .join('');
  
  dropdown.classList.add('show');
  
  // Add click handlers
  dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
    item.addEventListener('click', () => {
      selectAgent(item.dataset.value);
    });
  });
}

// Update selection highlight
function updateSelection(items) {
  items.forEach((item, index) => {
    if (index === selectedIndex) {
      item.classList.add('selected');
      item.scrollIntoView({ block: 'nearest' });
    } else {
      item.classList.remove('selected');
    }
  });
}

// Select an agent
function selectAgent(agentId) {
  document.getElementById('filterInput').value = agentId;
  hideAutocomplete();
}

// Hide autocomplete dropdown
function hideAutocomplete() {
  document.getElementById('autocompleteDropdown').classList.remove('show');
  selectedIndex = -1;
}

let currentFilterType = 'agent';

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('active');
}

function resetFilters() {
  document.getElementById('filterInput').value = '';
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  clearError();
}

function showError(message) {
  document.getElementById('errorContainer').innerHTML = `
    <div class="error-message">
      <i class="fas fa-exclamation-triangle"></i> ${message}
    </div>
  `;
}

function clearError() {
  document.getElementById('errorContainer').innerHTML = '';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function loadFeedback() {
  clearError();
  
  const filterValue = document.getElementById('filterInput').value.trim();
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const agentId = AGENT_MAP[filterValue];
  
  // Validation - ALL fields are required
  if (!filterValue) {
    showError('Please enter an agent Code');
    return;
  }

  if (!agentId) {
  showError('Invalid agent code. Please select from the dropdown.');
  return;
}
  
  if (!startDate || !endDate) {
    showError('Please select both start and end dates');
    return;
  }
  
  const start = new Date(startDate);
  const end = new Date(endDate);
  
  if (start >= end) {
    showError('Start date must be earlier than end date');
    return;
  }
  
  const tbody = document.getElementById('feedbackTable');
  tbody.innerHTML = `
    <tr>
      <td colspan="15" class="loading">
        <div>Loading feedback data...</div>
      </td>
    </tr>
  `;
  try {
    // Always use the combined date-range endpoint with agent_id
    const startISO = new Date(startDate).toISOString();
    const endISO = new Date(endDate).toISOString();
    const endpoint = `${FEEDBACK_API_BASE}/feedback_sentiment/date-range/by-user-or-agent?start_date=${encodeURIComponent(startISO)}&end_date=${encodeURIComponent(endISO)}&agent_id=${encodeURIComponent(agentId)}`;
    
    console.log('Fetching from:', endpoint);
    console.log('Agent Code:', filterValue, '-> Agent ID:', agentId);
    
    const response = await fetch(endpoint, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    
    let data = await response.json();
    let feedbackData = Array.isArray(data) ? data : (data.results || []);
    
    if (feedbackData.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="15" class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>No Feedback Found</h3>
            <p>No feedback data available for the selected filter</p>
          </td>
        </tr>
      `;
      document.getElementById('statsCards').classList.remove('show');
      return;
    }
    
    updateStats(feedbackData);
    renderTable(feedbackData);
    document.getElementById('statsCards').classList.add('show');
    
  } catch (error) {
    console.error('Error loading feedback:', error);
    showError(error.message || 'Failed to load feedback data');
    tbody.innerHTML = `
      <tr>
        <td colspan="15" class="empty-state">
          <i class="fas fa-exclamation-circle"></i>
          <h3>Error Loading Data</h3>
          <p>${error.message}</p>
        </td>
      </tr>
    `;
  }
}

function updateStats(feedbackData) {
  const total = feedbackData.length;
  const positive = feedbackData.filter(f => f.overall_sentiment === 'Positive').length;
  const neutral = feedbackData.filter(f => f.overall_sentiment === 'Neutral').length;
  const negative = feedbackData.filter(f => f.overall_sentiment === 'Negative').length;
  
  // Calculate overall sentiment based on majority
  let overallSentiment = 'N/A';
  if (total > 0) {
    if (positive > negative && positive > neutral) {
      overallSentiment = 'üòä Positive';
    } else if (negative > positive && negative > neutral) {
      overallSentiment = 'üòû Negative';
    } else if (neutral > positive && neutral > negative) {
      overallSentiment = 'üòê Neutral';
    } else if (positive === negative && positive > neutral) {
      overallSentiment = 'ü§î Mixed';
    } else {
      overallSentiment = 'üòê Neutral';
    }
  }
  
  document.getElementById('totalFeedback').textContent = total;
  document.getElementById('positiveFeedback').textContent = positive;
  document.getElementById('neutralFeedback').textContent = neutral;
  document.getElementById('negativeFeedback').textContent = negative;
  document.getElementById('overallSentiment').textContent = overallSentiment;
}

function renderTable(feedbackData) {
  const tbody = document.getElementById('feedbackTable');
  
  // ‚úÖ SORT BY LOGGED_AT IN DESCENDING ORDER (MOST RECENT FIRST)
  const sortedData = [...feedbackData].sort((a, b) => {
    const dateA = new Date(a.createdAt || 0);
    const dateB = new Date(b.createdAt || 0);
    return dateB - dateA; // ‚úÖ Descending order - most recent first
  });
  
  tbody.innerHTML = sortedData.map((fb, index) => {
    const sentiment = fb.overall_sentiment || 'Neutral';
    const sentimentIcon = sentiment === 'Positive' ? 'üòä' : sentiment === 'Negative' ? 'üòû' : 'üòê';
    
    const positiveList = fb.positive && fb.positive.length > 0
      ? `<ul class="list-items">${fb.positive.map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ul>`
      : '<em style="color: #999;">None</em>';
    
    let negativeList = '<em style="color: #999;">None</em>';
    let negativeExpandBtn = '';
    if (fb.negative && fb.negative.length > 0) {
    const listContent = fb.negative.map(item => `<li>${escapeHtml(item)}</li>`).join('');
    negativeList = `<ul class="list-items">${listContent}</ul>`;
    // Add expand button if content is long (more than 3 items or long text)
    if (fb.negative.length > 3 || listContent.length > 150) {
        negativeExpandBtn = `<button class="expand-btn" onclick="toggleExpand('negative-${index}')">Expand</button>`;
    }
}
    
    // Build detailed categories display with accordion
    let categoriesHtml = '<em style="color: #999;">None</em>';
    if (fb.categories && typeof fb.categories === 'object' && Object.keys(fb.categories).length > 0) {
      const hasContent = Object.entries(fb.categories).some(([_, items]) => 
        Array.isArray(items) && items.length > 0
      );
      
      if (!hasContent) {
        categoriesHtml = '<em style="color: #999;">No category items</em>';
      } else {
        categoriesHtml = '';
        let categoryIndex = 0;
        for (const [categoryName, items] of Object.entries(fb.categories)) {
          if (Array.isArray(items) && items.length > 0) {
            const accordionId = `category-${index}-${categoryIndex}`;
            categoriesHtml += `
              <div class="category-accordion">
                <div class="category-accordion-header" onclick="toggleCategoryAccordion('${accordionId}')">
                  <span>
                    <i class="fas fa-tag"></i>
                    ${escapeHtml(categoryName)} <span style="opacity: 0.8;">(${items.length} item${items.length > 1 ? 's' : ''})</span>
                  </span>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="category-accordion-body" id="${accordionId}">
                  <div class="category-accordion-content">
            `;
            items.forEach((item, itemIdx) => {
              const itemSentiment = item.sentiment || 'Neutral';
              categoriesHtml += `
                <div style="margin-bottom: ${itemIdx < items.length - 1 ? '12px' : '0'}; padding-bottom: ${itemIdx < items.length - 1 ? '12px' : '0'}; border-bottom: ${itemIdx < items.length - 1 ? '1px solid #e9ecef' : 'none'};">
                  <div class="category-sentence">"${escapeHtml(item.sentence || '')}"</div>
                  <div class="category-meta">
                    <span class="category-sentiment-tag ${itemSentiment}">
                      ${itemSentiment === 'Positive' ? 'üëç' : itemSentiment === 'Negative' ? 'üëé' : 'üòê'} ${itemSentiment}
                    </span>
                    <span style="color: #667eea; font-weight: 600;">Score: ${item.score || 0}/10</span>
                  </div>
                </div>
              `;
            });
            categoriesHtml += `
                  </div>
                </div>
              </div>
            `;
            categoryIndex++;
          }
        }
      }
    }
    
    // Render star rating
    const rating = parseInt(fb.rating) || 0;
    let starsHtml = '';
    for (let i = 1; i <= 5; i++) {
      if (i <= rating) {
        starsHtml += '<i class="fas fa-star"></i>';
      } else {
        starsHtml += '<i class="far fa-star"></i>';
      }
    }
    
    // Format dates - use exact backend values
    const createdAt = fb.created_at || 'N/A';
    
    return `
      <tr>
        <td>
          <div><strong>${escapeHtml(fb.user_name || 'N/A')}</strong></div>
        </td>
        <td><small>${escapeHtml(fb.session_id)}</small></td>
        <td><small>${createdAt}</small></td>
        <td>
          <div class="rating-stars">
            ${starsHtml}
            <span class="rating-number">${rating}/5</span>
          </div>
        </td>
        <td>
          <span class="sentiment-badge ${sentiment}">
            ${sentimentIcon} ${sentiment}
          </span>
        </td>
        <td>
        <div><span class="score-badge">${fb.positive_score || 0}</span> Positive</div>
        <div><span class="score-badge">${fb.negative_score || 0}</span> Negative</div>
        <div><span class="score-badge">${fb.overall_score || 0}</span> Overall</div>
        </td>
        <td>
          <div class="text-cell" id="summary-${index}">
            ${escapeHtml(fb.summary || 'N/A')}
          </div>
          ${fb.summary && fb.summary.length > 100 ? `<button class="expand-btn" onclick="toggleExpand('summary-${index}')">Expand</button>` : ''}
        </td>
        <td>
          <div class="text-cell" id="feedback-${index}">
            ${escapeHtml(fb.feedback || 'N/A')}
          </div>
          ${fb.feedback && fb.feedback.length > 100 ? `<button class="expand-btn" onclick="toggleExpand('feedback-${index}')">Expand</button>` : ''}
        </td>
        <td>${positiveList}</td>
        <td>
        <div class="text-cell" id="negative-${index}">
            ${negativeList}
        </div>
        ${negativeExpandBtn}
        </td>
        <td style="max-width: 400px;">
          <div id="categories-${index}">
            ${categoriesHtml}
          </div>
        </td>
        <td>
          <div class="text-cell" id="request-${index}">
            ${escapeHtml(fb.request || 'N/A')}
          </div>
          ${fb.request && fb.request.length > 100 ? `<button class="expand-btn" onclick="toggleExpand('request-${index}')">Expand</button>` : ''}
        </td>
        <td>
          <div class="text-cell" id="response-${index}">
            ${escapeHtml(fb.response || 'N/A')}
          </div>
          ${fb.response && fb.response.length > 100 ? `<button class="expand-btn" onclick="toggleExpand('response-${index}')">Expand</button>` : ''}
        </td>
         <td style="text-align: center;">
        <button class="btn btn-primary" style="padding: 8px 16px; font-size: 12px;" onclick="toggleExpandAll(${index})">
            Expand
        </button>
        </td>
      </tr>
    `;
  }).join('');
}


function toggleExpand(elementId) {
  const element = document.getElementById(elementId);
  const button = event.target;
  
  if (element.classList.contains('expanded')) {
    element.classList.remove('expanded');
    button.textContent = 'Expand';
  } else {
    element.classList.add('expanded');
    button.textContent = 'Collapse';
  }
}

function toggleCategoryAccordion(accordionId) {
  const body = document.getElementById(accordionId);
  const header = event.target.closest('.category-accordion-header');
  
  if (body.classList.contains('active')) {
    body.classList.remove('active');
    header.classList.remove('active');
  } else {
    body.classList.add('active');
    header.classList.add('active');
  }
}
function toggleExpandAll(rowIndex) {
  const button = event.target;
  const isExpanding = button.textContent === 'Expand';
  
  // List of all expandable elements in this row
  const elementIds = [
    `summary-${rowIndex}`,
    `feedback-${rowIndex}`,
    `negative-${rowIndex}`,
    `request-${rowIndex}`,
    `response-${rowIndex}`
  ];
  
  elementIds.forEach(id => {
    const element = document.getElementById(id);
    const elementButton = element?.nextElementSibling;
    
    if (element && elementButton && elementButton.classList.contains('expand-btn')) {
      if (isExpanding) {
        element.classList.add('expanded');
        elementButton.textContent = 'Collapse';
      } else {
        element.classList.remove('expanded');
        elementButton.textContent = 'Expand';
      }
    }
  });
  
  button.textContent = isExpanding ? 'Collapse' : 'Expand';
}

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
  await initAutocomplete();
  lucide.createIcons();
});
</script>

</body>
</html>